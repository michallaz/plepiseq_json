{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://raw.githubusercontent.com/michallaz/plepiseq_json/main/output_subschemes_phylogenetics/input_params_data.json",
  "type": "object",

  "$defs": {
    "bacterialPathogens": {
      "enum": ["salmonella", "escherichia", "campylobacter"]
    },
    "relPathFileOrDir": {
      "type": "string",
      "pattern": "^(\\./)?([A-Za-z0-9._-]+/)*[A-Za-z0-9._-]+/?$",
      "$comment": "Ścieżka względna względem ExecutionDir_dir; nie zaczyna się od '/'."
    },
    "anyPosixPathFileOrDir": {
      "type": "string",
      "pattern": "^(\\.?\\.?/)?([A-Za-z0-9._-]+/)*[A-Za-z0-9._-]+/?$",
      "$comment": "Dowolna ścieżka POSIX (bezwzględna lub względna); dopuszcza '.', '..', '/', './', '../'."
    },
    "dockerImageRef": {
      "type": "string",
      "minLength": 1,
      "pattern": "^([a-z0-9]+(?:[._-][a-z0-9]+)*/)?[a-z0-9._-]+(?::[A-Za-z0-9._-]+)?$",
      "$comment": "Permisywny wzorzec nazwy obrazu Dockera z opcjonalnym repo i tagiem."
    },
    "versionSemver": {
      "type": "string",
      "pattern": "^(\\d{1,2})\\.(\\d{1,2})\\.(\\d{1,2})$",
      "$comment": "Format X.Y.Z, np. 1.2.1."
    },
    "timeYYYYMMDD_HHMM": {
      "type": "string",
      "pattern": "^\\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\\d|3[01])\\s(0\\d|1\\d|2[0-3]):[0-5]\\d$",
      "$comment": "YYYY-MM-DD HH:MM; spójne z output.execution_time."
    }
  },

  "properties": {
    "pathogen": {
      "type": "string",
      "enum": ["sars-cov-2", "rsv", "influenza", "salmonella", "escherichia", "campylobacter"],
      "description": "Nazwa gatunku podana przez użytkownika.",
      "$comment": "Powinna być spójna z output.pathogen."
    },
    "subcategory_organism": {
      "type": "string",
      "minLength": 1,
      "description": "Nazwa serotypu/podtypu/typu.",
      "$comment": "Dla wirusów wartość z kolumny 'type', dla bakterii 'Serovar'."
    },
    "main_image": {
      "$ref": "#/$defs/dockerImageRef",
      "description": "Nazwa głównego obrazu Docker używanego do uruchomienia modułów."
    },
    "data_uruchomienia": {
      "$ref": "#/$defs/timeYYYYMMDD_HHMM",
      "description": "Data uruchomienia analizy (YYYY-MM-DD HH:MM).",
      "$comment": "Powinna odpowiadać output.execution_time."
    },
    "pipeline_version": {
      "$ref": "#/$defs/versionSemver",
      "description": "Wersja pipeline'u.",
      "$comment": "Spójne z output.pipeline_version."
    },

    "input_data": {
      "$ref": "#/$defs/anyPosixPathFileOrDir",
      "examples": ["/data/wgs/", "./input/", "metadata/sequences/"],
      "description": "Ścieżka do katalogu z plikami FASTA/GFF wskazana przez użytkownika.",
      "$comment": "Dawniej 'input_fasta'. Nie jest zależna od ExecutionDir_dir."
    },
    "input_metadata": {
      "$ref": "#/$defs/anyPosixPathFileOrDir",
      "examples": ["/data/metadata.tsv", "./meta/metadata.csv", "metadata.json"],
      "description": "Ścieżka do pliku metadanych wymaganych do uruchomienia programu.",
      "$comment": "Nie jest zależna od ExecutionDir_dir."
    },
    "results_dir": {
      "$ref": "#/$defs/relPathFileOrDir",
      "examples": ["wyniki/", "out/runA/", "./results/"],
      "description": "Ścieżka (względna do ExecutionDir_dir) gdzie program zapisuje wyniki."
    },

    "threshold_Ns": {
      "type": "number",
      "minimum": 0,
      "description": "Maksymalna dozwolona liczba N w sekwencji (QC)."
    },
    "threshold_ambiguites": {
      "type": "number",
      "minimum": 0,
      "description": "Maksymalna dozwolona liczba znaków innych niż A,T,G,C,N (QC)."
    },

    "map_detail": {
      "type": "string",
      "enum": ["city", "country"],
      "description": "Poziom szczegółowości lokalizacji dla znaczników na mapie w Microreact."
    },

    "phylogentic_model": {
      "type": "string",
      "minLength": 1,
      "description": "Model używany do predykcji filogramu."
    },
    "phylogenetic_bootstrap": {
      "type": "integer",
      "minimum": 1,
      "description": "Liczba replik bootstrap do oceny wsparcia filogramu."
    },
    "min_support": {
      "type": "integer",
      "minimum": 0,
      "description": "Minimalna wartość wsparcia; gałęzie poniżej progu są zwijane."
    },
    "starting_trees": {
      "type": "integer",
      "minimum": 1,
      "description": "Liczba drzew startowych użytych przy estymacji filogramu."
    },
    "clockrate": {
      "type": "number",
      "exclusiveMinimum": 0,
      "description": "Tempo ewolucji (clockrate) dla danego organizmu."
    },

    "input_ids": {
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "items": {
        "type": "string",
        "minLength": 1,
        "pattern": "^[^\\s]+$",
        "description": "ID próbki bez spacji."
      },
      "description": "Lista wszystkich ID próbek przekazanych w metadanych."
    },

    "input_type_bacteria": {
      "type": "string",
      "enum": ["fasta", "gff"],
      "description": "Typ danych wejściowych (tylko dla bakterii)."
    },
    "prokka_image": {
      "$ref": "#/$defs/dockerImageRef",
      "description": "Nazwa obrazu Docker z programem prokka (tylko dla bakterii)."
    }
  },

  "required": [
    "pathogen",
    "subcategory_organism",
    "main_image",
    "data_uruchomienia",
    "pipeline_version",
    "input_data",
    "input_metadata",
    "results_dir",
    "threshold_Ns",
    "threshold_ambiguites",
    "map_detail",
    "phylogentic_model",
    "phylogenetic_bootstrap",
    "min_support",
    "starting_trees",
    "clockrate",
    "input_ids"
  ],

  "allOf": [
    {
      "if": {
        "properties": { "pathogen": { "$ref": "#/$defs/bacterialPathogens" } },
        "required": ["pathogen"]
      },
      "then": {
        "required": ["input_type_bacteria", "prokka_image"]
      }
    }
  ],

  "additionalProperties": false
}

